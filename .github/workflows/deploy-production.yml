# Production Deployment Pipeline
# Automated deployment to production environment with approval gates

name: Deploy to Production

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:

env:
  NODE_VERSION: '18.x'
  PRODUCTION_URL: 'https://uimp.vercel.app'

jobs:
  pre-deployment-checks:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Verify all tests passed
      run: |
        echo "Verifying CI pipeline status..."
        # This would typically check the status of the CI workflow
        # For now, we'll assume it passed if we reach this point

    - name: Check for breaking changes
      run: |
        echo "Checking for breaking changes..."
        # Add breaking change detection logic here
        # Could use semantic versioning or changelog analysis

    - name: Security scan
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        exit-code: '1'
        severity: 'CRITICAL,HIGH'

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: pre-deployment-checks
    environment: 
      name: production
      url: ${{ env.PRODUCTION_URL }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: client/package-lock.json

    - name: Install dependencies
      run: |
        cd client
        npm ci

    - name: Build application
      run: |
        cd client
        npm run build
      env:
        NODE_ENV: production
        NEXT_PUBLIC_API_URL: ${{ secrets.PRODUCTION_API_URL }}
        NEXT_PUBLIC_APP_ENV: production
        NEXT_PUBLIC_ANALYTICS_ID: ${{ secrets.ANALYTICS_ID }}

    - name: Deploy to Vercel
      id: deploy
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        working-directory: ./client
        scope: ${{ secrets.VERCEL_ORG_ID }}
        alias-domains: |
          uimp.vercel.app
          app.uimp.com

    - name: Wait for deployment
      run: |
        echo "Waiting for deployment to be ready..."
        sleep 60

    - name: Run production smoke tests
      run: |
        echo "Running production smoke tests..."
        
        # Health check
        curl -f ${{ env.PRODUCTION_URL }}/api/health || exit 1
        
        # Critical user journeys
        curl -f ${{ env.PRODUCTION_URL }}/ || exit 1
        curl -f ${{ env.PRODUCTION_URL }}/login || exit 1
        curl -f ${{ env.PRODUCTION_URL }}/signup || exit 1

    - name: Run production E2E tests
      run: |
        cd client
        npm run test:e2e:production
      env:
        PLAYWRIGHT_BASE_URL: ${{ env.PRODUCTION_URL }}

    - name: Update deployment status
      run: |
        echo "Deployment successful to ${{ env.PRODUCTION_URL }}"

  post-deployment:
    name: Post-deployment Tasks
    runs-on: ubuntu-latest
    needs: deploy-production
    if: success()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Lighthouse audit
      run: |
        npm install -g @lhci/cli@0.12.x
        lhci autorun --upload.target=temporary-public-storage
      env:
        LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

    - name: Monitor application metrics
      run: |
        echo "Setting up monitoring alerts..."
        # Add monitoring setup here (e.g., DataDog, New Relic)

    - name: Create GitHub release
      if: startsWith(github.ref, 'refs/tags/')
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        draft: false
        prerelease: false

    - name: Notify successful deployment
      uses: 8398a7/action-slack@v3
      with:
        status: success
        channel: '#deployments'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        fields: repo,message,commit,author
        custom_payload: |
          {
            text: "ðŸŽ‰ Production deployment successful!",
            attachments: [{
              color: "good",
              fields: [{
                title: "Environment",
                value: "Production",
                short: true
              }, {
                title: "URL",
                value: "${{ env.PRODUCTION_URL }}",
                short: true
              }, {
                title: "Version",
                value: "${{ github.sha }}",
                short: true
              }]
            }]
          }

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: deploy-production
    if: failure()

    steps:
    - name: Rollback deployment
      run: |
        echo "Rolling back deployment..."
        # Add rollback logic here
        # This could involve deploying the previous version

    - name: Notify rollback
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        channel: '#deployments'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        fields: repo,message,commit,author
        custom_payload: |
          {
            text: "ðŸ”„ Production deployment rolled back due to failure",
            attachments: [{
              color: "warning",
              fields: [{
                title: "Environment",
                value: "Production",
                short: true
              }, {
                title: "Action",
                value: "Rollback initiated",
                short: true
              }]
            }]
          }
// Prisma Schema for Unified Internship & Mentorship Portal (UIMP)
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  STUDENT
  MENTOR
  ADMIN
  SUPER_ADMIN
}

enum ApplicationStatus {
  DRAFT
  APPLIED
  SHORTLISTED
  INTERVIEW
  OFFER
  REJECTED
}

enum ApplicationPlatform {
  LINKEDIN
  COMPANY_WEBSITE
  REFERRAL
  JOB_BOARD
  CAREER_FAIR
  OTHER
}

enum FeedbackTag {
  RESUME
  DSA
  SYSTEM_DESIGN
  COMMUNICATION
}

enum FeedbackPriority {
  LOW
  MEDIUM
  HIGH
}

enum NotificationType {
  FEEDBACK_RECEIVED
  APPLICATION_STATUS_CHANGED
  MENTOR_ASSIGNED
  SYSTEM_ANNOUNCEMENT
}

// ============================================
// MODELS
// ============================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  passwordHash String @map("password_hash")
  role      UserRole
  firstName String?  @map("first_name")
  lastName  String?  @map("last_name")
  profileImageUrl String? @map("profile_image_url")
  isActive  Boolean  @default(true) @map("is_active")
  organizationId String? @map("organization_id") // For multi-tenant support
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  lastLoginAt DateTime? @map("last_login_at")

  // Relations
  applications      Application[]
  feedbackGiven     Feedback[]     @relation("MentorFeedback")
  notifications     Notification[]
  mentorAssignments MentorAssignment[] @relation("MentorAssignments")
  studentAssignments MentorAssignment[] @relation("StudentAssignments")
  auditLogs         AuditLog[]
  sessions          UserSession[]
  organization      Organization? @relation(fields: [organizationId], references: [id])

  @@index([email])
  @@index([role])
  @@index([organizationId])
  @@index([isActive])
  @@map("users")
}

model Application {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  company   String
  role      String
  platform  ApplicationPlatform
  status    ApplicationStatus @default(DRAFT)
  resumeUrl String?  @map("resume_url")
  notes     String?  @db.Text
  deadline  DateTime?
  appliedDate DateTime? @map("applied_date")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  feedback Feedback[]

  @@index([userId])
  @@index([status])
  @@index([company])
  @@index([createdAt])
  @@map("applications")
}

model Feedback {
  id            String          @id @default(uuid())
  applicationId String          @map("application_id")
  mentorId      String          @map("mentor_id")
  content       String          @db.Text
  tags          FeedbackTag[]
  priority      FeedbackPriority
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")

  // Relations
  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  mentor      User        @relation("MentorFeedback", fields: [mentorId], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@index([mentorId])
  @@index([createdAt])
  @@map("feedback")
}

model Notification {
  id        String          @id @default(uuid())
  userId    String          @map("user_id")
  type      NotificationType
  title     String
  message   String          @db.Text
  read      Boolean         @default(false)
  expiresAt DateTime?       @map("expires_at")
  createdAt DateTime        @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}

model MentorAssignment {
  id        String   @id @default(uuid())
  mentorId  String   @map("mentor_id")
  studentId String   @map("student_id")
  isActive  Boolean  @default(true) @map("is_active")
  assignedAt DateTime @default(now()) @map("assigned_at")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  mentor  User @relation("MentorAssignments", fields: [mentorId], references: [id], onDelete: Cascade)
  student User @relation("StudentAssignments", fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([mentorId, studentId])
  @@index([mentorId])
  @@index([studentId])
  @@index([isActive])
  @@map("mentor_assignments")
}

// ============================================
// RBAC AND AUDIT MODELS
// ============================================

model AuditLog {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  action         String
  resource       String
  resourceId     String?  @map("resource_id")
  result         String   // ALLOWED or DENIED
  reason         String?
  metadata       String?  @db.Text // JSON string
  ipAddress      String   @map("ip_address")
  userAgent      String   @map("user_agent")
  organizationId String?  @map("organization_id")
  timestamp      DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([result])
  @@index([timestamp])
  @@index([organizationId])
  @@map("audit_logs")
}

model UserSession {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  sessionToken   String   @unique @map("session_token")
  ipAddress      String   @map("ip_address")
  userAgent      String   @map("user_agent")
  isActive       Boolean  @default(true) @map("is_active")
  lastActivity   DateTime @default(now()) @map("last_activity")
  expiresAt      DateTime @map("expires_at")
  riskScore      Int      @default(0) @map("risk_score")
  mfaVerified    Boolean  @default(false) @map("mfa_verified")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionToken])
  @@index([isActive])
  @@index([expiresAt])
  @@map("user_sessions")
}

// Future: Organization/Tenant support
model Organization {
  id              String   @id @default(uuid())
  name            String
  domain          String?  @unique
  subscriptionTier String  @default("basic") @map("subscription_tier") // basic, premium, enterprise
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  users User[]

  @@index([domain])
  @@index([isActive])
  @@map("organizations")
}

